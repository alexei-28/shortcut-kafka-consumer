# shortcut-kafka-consumer
Shortcut Kafka consumer test project

Producer repo: https://github.com/alexei-28/shortcut-kafka-producer

Consumer repo: https://github.com/alexei-28/shortcut-kafka-consumer

Mentor platform - Shortcut: https://shortcut.education/

---
* **Environment**
    * Java 21
    * Gradle: 8.14
    * Spring Boot: 3.5.7
    * Docker
      * Create 1 Kafka broker and kafka-ui by kafka-docker-compose.yml
      * Create PostgreSQL database by postgres-docker-compose.yml
  *  Kafka UI - https://github.com/provectus/kafka-ui
      * Address http://localhost:8080/
    * Test tools:
      * JUnit 5
      * Mockito
      * Testcontainers

---
* **Install application environment**
  * docker-compose -f postgresql-docker-compose.yml up -d
  * Run application: ./gradlew bootRun
  * Validate is application is running: http://localhost:8081/api/v1/hello

---
# Kafka — практические задачи

---

## Задача 1 — «Аналитика экранов мобильного приложения»

Продуктовая команда собирает данные о том, какие экраны клиент открывает в мобильном приложении. Данные идут в ML-пайплайн для рекомендаций.

**Что говорит бизнес:**

- Нагрузка ~50 000 событий/сек
- «Потерять пару процентов — ок, модель переживёт. Но дубли портят модель — экраны кажутся популярнее, чем есть»
- Нужна максимальная скорость, инфраструктуру раздувать нельзя

**Задание:** реализуй producer и consumer на Spring Kafka. Выбери подходящую гарантию доставки и обоснуй конфигурацию.

---

## Задача 2 — «Начисление кэшбэка»

После покупки по карте клиенту начисляется кэшбэк. Событие приходит из процессингового центра.

**Что говорит бизнес:**

- Клиент не получил кэшбэк — жалоба в ЦБ. Терять события нельзя
- Двойное начисление — неприятно, но ежедневная сверка поймает. Допустимо как редкий случай
- Кэшбэк считается начисленным только после записи в PostgreSQL

**Задание:** реализуй producer и consumer. Обоснуй гарантию. В коде комментарием покажи точку, где возможен побочный эффект выбранного подхода.

---

## Задача 3 — «Перевод через СБП»

Сервис обрабатывает межбанковские переводы. Клиент инициировал перевод → списание со счёта → результат в следующий сервис по цепочке.

**Что говорит бизнес:**

- Двойное списание — P1, штраф от регулятора
- Потеря перевода — P1, клиент без денег
- Нужен полный аудит каждой операции
- Стек: PostgreSQL + Kafka

**Задание:** реализуй полный цикл обработки. Ни потеря, ни дубль недопустимы — выбери подход и обоснуй.

---

## Задача 4 — «Битые сообщения из CFT»

`customers-sync-processor` получает обновления клиентов из CFT. Иногда приходят невалидные события — плохой ИНН, нет адреса. Вчера одно такое сообщение заблокировало consumer на 40 минут, лаг рос, данные не обновлялись.

**Что говорит бизнес:**

- Плохое сообщение не должно блокировать остальные
- Нужно видеть все проблемные сообщения в одном месте и уметь переотправить после фикса
- Решение через отдельный Kafka-топик для «мёртвых» сообщений

**Задание:** реализуй механизм изоляции ошибочных сообщений через DLQ-топик. Настрой retry-политику, обогати сообщение метаинформацией об ошибке, сделай эндпоинт для ручной переотправки.

---

## Задача 5 — «DLQ, но удобнее»

Через полгода команда поняла: DLQ-топик неудобен. Нельзя фильтровать, нельзя массово ретраить, операционники тратят по 2 часа в день на `kafka-console-consumer`.

**Что говорит бизнес:**

- Нужна фильтрация по топику, статусу, дате
- Ручной retry одного сообщения и массовый retry
- Возможность пометить «разобрано, не нужно»
- Автоматический retry по расписанию для транзиентных ошибок

**Задание:** реализуй DLQ через PostgreSQL вместо Kafka-топика. Таблица, REST API для управления, scheduled job для автоматического retry.

---

## Задача 6 — «Тесты»

Тимлид на ревью: «Без тестов не вмержу».

**Что покрыть:**

- Задача 2: happy path (сообщение → обработка → запись в БД), поведение при повторной доставке
- Задача 4: валидное сообщение обработано, невалидное ушло в DLQ-топик с правильными хедерами, после poison pill остальные сообщения продолжают обрабатываться
- Задача 5: невалидное сообщение → запись в таблицу DLQ, ручной retry через REST, массовый retry

**Ограничения:** тесты работают в CI без внешних зависимостей, никаких `Thread.sleep`, прогон < 2 минут.

**Задание:** напиши интеграционные тесты. Выбери и обоснуй инструменты (embedded kafka, testcontainers, или что-то ещё).
